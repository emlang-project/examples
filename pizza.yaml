# Pizza delivery system

# Customer places an order
slices:
  Add item:
    steps:
      - t: Website / Menu
      - c: Add item to order
      - e: Order / Order started
      - e: Order / Item added
      - v: Order summary
    tests:
      Add first item:
        given: # No order exists yet
        when:
          - c: Add item to order
            props:
              order id: order-123
              item id: pepperoni-pizza
        then:
          - e: Order / Order started
            props:
              order id: order-123
          - e: Order / Item added
            props:
              order id: order-123
              item id: pepperoni-pizza
          - v: Order summary
            props:
              items:
                - pepperoni-pizza/18.99
              total: 18.99

      Add item to existing order:
        given:
          - e: Order / Order started
            props:
              order id: order-123
          - e: Order / Item added
            props:
              order id: order-123
              item id: pepperoni-pizza
        when:
          - c: Add item to order
            props:
              order id: order-123
              item id: cheese-pizza
        then:
          - e: Order / Item added
            props:
              order id: order-123
              item id: cheese-pizza
          - v: Order summary
            props:
              items:
                - pepperoni-pizza/18.99
                - cheese-pizza/14.99
              total: 33.98

  Remove item:
    steps:
      - t: Website / Order
      - c: Remove item from order
      - e: Order / Item removed from order
      - v: Order summary
    tests:
      Remove item from order:
        given:
          - e: Order / Order started
            props:
              order id: order-123
          - e: Order / Item added
            props:
              order id: order-123
              item id: pepperoni-pizza
          - e: Order / Item added
            props:
              order id: order-123
              item id: cheese-pizza
        when:
          - c: Remove item from order
            props:
              order id: order-123
              item id: cheese-pizza
        then:
          - e: Order / Item removed from order
            props:
              order id: order-123
              item id: cheese-pizza
          - v: Order summary
            props:
              items:
                - pepperoni-pizza/18.99
              total: 18.99

      Remove last item:
        given:
          - e: Order / Order started
            props:
              order id: order-123
          - e: Order / Item added
            props:
              order id: order-123
              item id: pepperoni-pizza
        when:
          - c: Remove item from order
            props:
              order id: order-123
              item id: pepperoni-pizza
        then:
          - e: Order / Item removed from order
            props:
              order id: order-123
              item id: pepperoni-pizza
          - v: Order summary
            props:
              items:
              total: 0.00

  View order items:
    steps:
      - v: Order summary
    tests:
      No order exists:
        given: # No order exists yet
        then: # No view to display

      Order with items:
        given:
          - e: Order / Order started
            props:
              order id: order-123
          - e: Order / Item added
            props:
              order id: order-123
              item id: pepperoni-pizza
          - e: Order / Item added
            props:
              order id: order-123
              item id: cheese-pizza
        then:
          - v: Order summary
            props:
              items:
                - pepperoni-pizza/18.99
                - cheese-pizza/14.99
              total: 33.98
---
# Customer finalizes and pays
slices:
  Set delivery details:
    steps:
      - t: Website / Delivery form
      - c: Set delivery details
      - e: Order / Delivery details set
      - v: Order summary
    tests:
      Valid delivery details:
        given:
          - e: Order / Order started
            props:
              order id: order-123
        when:
          - c: Set delivery details
            props:
              order id: order-123
              delivery address: "1337 rue Saint-Jean, Québec"
              email: "joe@example.com"
              phone number: "418-555-1234"
              desired time: "18:00"
        then:
          - e: Order / Delivery details set
            props:
              order id: order-123
              delivery address: "1337 rue Saint-Jean, Québec"
              email: "joe@example.com"
              phone number: "418-555-1234"
              desired time: "18:00"

      Address outside delivery zone:
        given:
          - e: Order / Order started
            props:
              order id: order-123
        when:
          - c: Set delivery details
            props:
              order id: order-123
              delivery address: "123 rue Saint-Denis, Montréal"
              email: "joe@example.com"
              desired time: "18:00"
        then:
          - x: Address outside delivery zone

      Time before opening hours:
        given:
          - e: Order / Order started
            props:
              order id: order-123
        when:
          - c: Set delivery details
            props:
              order id: order-123
              delivery address: "1337 rue Saint-Jean, Québec"
              email: "joe@example.com"
              desired time: "08:00"
        then:
          - x: Desired time outside delivery hours

      Time after closing hours:
        given:
          - e: Order / Order started
            props:
              order id: order-123
        when:
          - c: Set delivery details
            props:
              order id: order-123
              delivery address: "1337 rue Saint-Jean, Québec"
              email: "joe@example.com"
              desired time: "23:00"
        then:
          - x: Desired time outside delivery hours

  Initiate payment:
    steps:
      - t: Website / Payment form
      - c: Initiate payment
      - e: Order / Payment requested
    tests:
      Payment initiated:
        given:
          - e: Order / Order started
            props:
              order id: order-123
          - e: Order / Item added
            props:
              order id: order-123
              item id: pepperoni-pizza
          - e: Order / Delivery details set
            props:
              order id: order-123
              delivery address: "1337 rue Saint-Jean, Québec"
              email: "joe@example.com"
              desired time: "18:00"
        when:
          - c: Initiate payment
            props:
              order id: order-123
        then:
          - e: Order / Payment requested
            props:
              order id: order-123

      Cannot pay empty order:
        given:
          - e: Order / Order started
            props:
              order id: order-123
          - e: Order / Delivery details set
            props:
              order id: order-123
              delivery address: "1337 rue Saint-Jean, Québec"
              email: "joe@example.com"
              desired time: "18:00"
        when:
          - c: Initiate payment
            props:
              order id: order-123
        then:
          - x: Order must have items

      Cannot pay without delivery details:
        given:
          - e: Order / Order started
            props:
              order id: order-123
          - e: Order / Item added
            props:
              order id: order-123
              item id: pepperoni-pizza
        when:
          - c: Initiate payment
            props:
              order id: order-123
        then:
          - x: Delivery details required

  # Processor slice: triggered by payment gateway webhook
  Confirm payment:
    steps:
      - t: Payment gateway / Webhook
      - c: Confirm payment
      - e: Order / Payment confirmed
      - v: Order confirmation
    tests:
      Payment confirmed:
        given:
          - e: Order / Payment requested
            props:
              order id: order-123
        when:
          - c: Confirm payment
            props:
              order id: order-123
        then:
          - e: Order / Payment confirmed
            props:
              order id: order-123
          - v: Order confirmation
            props:
              order id: order-123

# Document 3: Preparation and delivery
---
slices:
  # Processor slice: scheduler triggers preparation at the right time before desired delivery
  Start preparation:
    steps:
      - e: Order / Payment confirmed
      - t: Scheduler / Preparation timer
      - c: Start preparation
      - e: Kitchen / Preparation started
      - v: Kitchen dashboard
    tests:
      Preparation started:
        given:
          - e: Order / Payment confirmed
            props:
              order id: order-123
        when:
          - c: Start preparation
            props:
              order id: order-123
        then:
          - e: Kitchen / Preparation started
            props:
              order id: order-123
          - v: Kitchen dashboard
            props:
              order id: order-123

  Assign driver:
    steps:
      - v: Kitchen dashboard
      - t: Kitchen / Assign driver form
      - c: Assign driver
      - e: Delivery / Driver assigned
      - v: Driver dashboard
    tests:
      Driver assigned to order:
        given:
          - e: Kitchen / Preparation started
            props:
              order id: order-123
        when:
          - c: Assign driver
            props:
              order id: order-123
              driver id: driver-456
        then:
          - e: Delivery / Driver assigned
            props:
              order id: order-123
              driver id: driver-456

      No driver available:
        when:
          - c: Assign driver
            props:
              order id: order-123
        then:
          - x: No driver available

  Mark delivered:
    steps:
      - v: Driver dashboard
      - t: Driver app / Delivery form
      - c: Mark delivered
      - e: Delivery / Order delivered
      - v: Order status
    tests:
      Driver marks order as delivered:
        given:
          - e: Delivery / Driver assigned
            props:
              order id: order-123
              driver id: driver-456
        when:
          - c: Mark delivered
            props:
              order id: order-123
              driver id: driver-456
        then:
          - e: Delivery / Order delivered
            props:
              order id: order-123

  Confirm reception:
    steps:
      - v: Order status
      - t: Website / Reception form
      - c: Confirm reception
      - e: Order / Reception confirmed
      - v: Order status
    tests:
      Customer confirms reception:
        given:
          - e: Delivery / Order delivered
            props:
              order id: order-123
        when:
          - c: Confirm reception
            props:
              order id: order-123
        then:
          - e: Order / Reception confirmed
            props:
              order id: order-123
